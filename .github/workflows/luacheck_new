on:
  push:
    paths:
      - '**.lua' # Only run if pushed commits include a change to a Lua (.lua) file.
      - 'extension.xml'
  pull_request:
    # Only run if pull request includes a change to a Lua (.lua) file.
    paths:
      - '**.lua'
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:

name: Run Luacheck on Default Branch

jobs:
  inheritrepos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Get Rulesets and Extensions to Inherit From
        id: inheritpackages
        uses: mavrosxristoforos/get-xml-info@1.1.0
        with:
          xml-file: 'extension.xml'
          xpath: '//properties//luacheck//repos'

      - id: outerparen
        uses: ashley-taylor/regex-property-action@1.2
        with:
          value: ${{ steps.inheritpackages.outputs.info }}
          regex: '(.+)'
          replacement: '[\"$1\"]'

      - id: innerparen
        uses: ashley-taylor/regex-property-action@1.2
        with:
          value: ${{ steps.outerparen.outputs.value }}
          regex: ','
          replacement: '\",\"'

      - id: set-matrix
        run: echo "::set-output name=repos::{ ${{ steps.innerparen.outputs.value }} }"

    outputs:
      repos: ${{ steps.set-matrix.outputs.repos }}

  luacheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Install Lua/LuaJIT
        uses: leafo/gh-actions-lua@v9
        with:
          luaVersion: 5.1

      # Process extension code
      - name: Running luacheck
        uses: nebularg/actions-luacheck@v1
        with:
          files: '.'
          config: https://raw.githubusercontent.com/bmos/FG-luacheck/main/.luacheckrc
          args: '--no-color --std --exclude-files .install/*'
          annotate: 'warning'
